sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/IconPool"],function(e,t,a,r,s,l){"use strict";var i=new sap.m.BusyDialog;var o=sap.ui.core.format.NumberFormat.getFloatInstance({maxFractionDigits:3,decimalSeparator:",",groupingEnabled:true});return e.extend("com.salesbom.culligan.salesbomdisplay.controller.Worklist",{formatter:a,onInit:function(){var e=new t({worklistTableTitle:this.getResourceBundle().getText("worklistTableTitle"),bomMaterialTableCount:""});this.getView().setModel(e,"worklistView");var a=new t({salesTableTitle:this.getResourceBundle().getText("salesTableTitle"),salesOrderTableCount:""});this.getView().setModel(a,"salesView");var r=[];var s={};var i={fontFamily:"SAP-icons-TNT",fontURI:sap.ui.require.toUrl("sap/tnt/themes/base/fonts/")};l.registerFont(i);r.push(l.fontLoaded("SAP-icons-TNT"));s["SAP-icons-TNT"]=i},matonDataExport:function(){this.onExcelDownload(this)},onSalesFinished:function(e){var t,a=e.getSource(),r=e.getParameter("total");if(r&&a.getBinding("items").isLengthFinal()){t=this.getResourceBundle().getText("salesTableTitleCount",[r])}else{t=this.getResourceBundle().getText("salesTableTitle")}this.getView().getModel("salesView").setProperty("/salesTableTitle",t);this.getView().getModel("salesView").setProperty("/salesOrderTableCount",[r])},onSearch:function(e){if(e.getParameters().refreshButtonPressed){this.onRefresh()}else{var t=[];var a=e.getParameter("query");if(a&&a.length>0){var r=sap.ui.model.FilterOperator.Contains;t=[new sap.ui.model.Filter([new sap.ui.model.Filter("bom",r,a)],false)]}this._applySearch(t)}},onSaleslocalSearch:function(e){if(e.getParameters().refreshButtonPressed){this.onSalesRefresh()}else{var t=[];var a=e.getParameter("query");if(a&&a.length>0){var r=sap.ui.model.FilterOperator.Contains;t=[new sap.ui.model.Filter([new sap.ui.model.Filter("Material",r,a)],false)]}this._applySalesSearch(t)}},_applySalesSearch:function(e){var t=this.getView().byId("tab");t.getBinding("items").filter(e,"Application")},_applySearch:function(e){var t=this.getView().byId("mattab");t.getBinding("items").filter(e,"Application")},onRefresh:function(){var e=this.getView().byId("mattab");e.getBinding("items").refresh()},onSalesRefresh:function(){var e=this.getView().byId("tab");e.getBinding("items").refresh()},onClear:function(){var e=this.getView().byId("matbtnId");var t=e.getAllFilterItems(true);e.determineControlByFilterItem(t[0]).setValue("");e.determineControlByFilterItem(t[1]).setValue("")},onSalesFilterClear:function(){var e=this.getView().byId("btnId");var t=e.getAllFilterItems(true);e.determineControlByFilterItem(t[0]).setValue("")},onUpdateFinished:function(e){var t,a=e.getSource(),r=e.getParameter("total");if(r&&a.getBinding("items").isLengthFinal()){t=this.getResourceBundle().getText("worklistTableTitleCount",[r])}else{t=this.getResourceBundle().getText("worklistTableTitle")}this.getView().getModel("worklistView").setProperty("/worklistTableTitle",t);this.getView().getModel("worklistView").setProperty("/bomMaterialTableCount",[r])},onLiveChange:function(e){var t=e.getSource().getValue();this.getView().byId("matidPlant").setValue(t.toUpperCase())},matonGo:function(){i.open();var e=this;sap.m.MessageBox.show(" Do you want to proceed?.",{icon:sap.m.MessageBox.Icon.INFORMATION,title:"Search BOM",actions:["OK","Cancel"],onClose:function(t){if(t==="OK"){e.onBOMSearch()}if(t==="Cancel"){i.close()}},initialFocus:"OK"})},onBOMSearch:function(){var e=this.getView().byId("matmultiInput").getValue();var t=this.getView().byId("matidPlant").getValue().toString();if(e.length===0||t.length===0){sap.m.MessageBox.warning("Please enter all mandatory fields.");i.close()}else{this.connectServer()}},connectServer:function(){var e=new sap.ui.model.json.JSONModel;this.getView().setModel(e,"BRF");var t=0,a=[],r=false,s,l,n=[],u=true,d=0,c=[],f=[],m=[],p=[],g=[],h=0;var M=[this.getView().byId("matmultiInput").getValue()];var w=this.getView().byId("matidPlant").getValue().toString();var S=this.getView().getModel("modelA");var O=this.getView().getModel();$.sap.brk=O;var v=this;var P=function(O,F,y){for(var V=0;V<F.length;V++){f.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.EQ,F[V]),new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,w)],and:true}))}m.push(new sap.ui.model.Filter({filters:f,and:false}));for(V=0;V<y.length;V++){g.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Product",sap.ui.model.FilterOperator.EQ,y[V]),new sap.ui.model.Filter("ValuationArea",sap.ui.model.FilterOperator.EQ,w)],and:true}))}p.push(new sap.ui.model.Filter({filters:g,and:false}));var I=function(e){return new Promise(function(t,a){if(F.length===0){t("")}else{O.read(e,{filters:m,urlParameters:{$select:"BillOfMaterialComponent,IsAssembly,Material,BillOfMaterialItemNumber,ComponentDescription,BillOfMaterialItemQuantity",$orderby:"BillOfMaterialItemNumber"},async:false,success:function(e){if(e.results.length===0){i.close();v.getView().byId("matmultiInput").setValue("");v.getView().byId("matidPlant").setValue("");v.getView().byId("matidSC").setValue("");v.getView().byId("matidBOM").setValue("");v.getView().byId("matidPSC").setValue("");v.getView().byId("matidDiff").setValue("");sap.m.MessageToast.show("No Records Found");return}t(e)},error:function(e){a(e)}})}})},b=function(e){return new Promise(function(t,a){if(F.length===0){t("")}else{O.read(e,{filters:m,urlParameters:{$select:"BillOfMaterialVariantUsage,Material"},async:false,success:function(e){t(e)},error:function(e){a(e)}})}})},B=function(e){return new Promise(function(t,a){S.read(e,{filters:p,urlParameters:{$select:"StandardPrice,Product,ValuationArea,PriceUnitQty"},async:false,success:function(e){t(e)},error:function(e){a(e)}})})};Promise.all([I("/MaterialBOMItem"),b("/MaterialBOM"),B("/A_ProductValuation")]).then(function(w){if(w[0]===""&&w[1]===""){for(V=0;V<w[2].results.length;V++){a.push(w[2].results[V])}for(V=0;V<n.length;V++){for(var S=0;S<a.length;S++){if(n[V].bom===a[S].Product){n[V].stc=a[S].StandardPrice;n[V].psc=parseFloat(a[S].StandardPrice/a[S].PriceUnitQty).toFixed(3);n[V].tsc=parseFloat(n[V].qty*(a[S].StandardPrice/a[S].PriceUnitQty)).toFixed(3)}}}var O=0;for(S=0;S<n.length;S++){if(n[S].lvl===1){O=O+parseFloat(n[S].tsc)}}var F=O-$.sap.spc;var y=JSON.parse(JSON.stringify(n));y[0].msp=o.format($.sap.spc);for(V=0;V<y.length;V++){y[V].stc=o.format(y[V].stc);y[V].psc=o.format(y[V].psc);y[V].tsc=o.format(y[V].tsc)}var I=new sap.ui.model.json.JSONModel;I.setSizeLimit(y.length);I.setData(y);v.getView().setModel(I,"OPM");i.close();e=new sap.ui.model.json.JSONModel;e.setSizeLimit(n.length);e.setData(n);v.getView().byId("matidBOM").setValue($.sap.usg);v.getView().byId("matidSC").setValue($.sap.spc);v.getView().byId("matidPSC").setValue($.sap.psc);v.getView().byId("matidDiff").setValue(parseFloat(F).toFixed(3));v.getView().setModel(e,"BRF")}else{h+=1;for(var b=0;b<w[0].results.length;b++){for(var B=0;B<w[1].results.length;B++){if(w[0].results[b].Material===w[1].results[B].Material){d+=1;c.push({mat:w[0].results[b].Material,itm:w[0].results[b].BillOfMaterialItemNumber,bom:w[0].results[b].BillOfMaterialComponent,asm:w[0].results[b].IsAssembly,des:w[0].results[b].ComponentDescription,qty:w[0].results[b].BillOfMaterialItemQuantity,usg:w[1].results[B].BillOfMaterialVariantUsage,stc:"",psc:"",tsc:"",msp:"",lvl:h,idx:d})}}}for(V=0;V<w[2].results.length;V++){a.push(w[2].results[V])}if(u){$.sap.usg=w[1].results[0].BillOfMaterialVariantUsage;$.sap.spc=w[2].results[0].StandardPrice;$.sap.psc=parseFloat(w[2].results[0].StandardPrice/w[2].results[0].PriceUnitQty).toFixed(3);for(var C=0;C<M.length;C++){for(var T=0;T<c.length;T++){if(M[C]===c[T].mat){n.push(c[T])}}}}if(r){for(var x=0;x<n.length;x++){for(var N=0;N<c.length;N++){if(n[x].asm.length>0){if(n[x].bom===c[N].mat){t+=1;n.splice(x+t,0,c[N])}}}t=0}}c=[];u=false;r=true;s=[];l=[];for(var Q=0;Q<w[0].results.length;Q++){if(w[0].results[Q].IsAssembly.length>0){s.push(w[0].results[Q].BillOfMaterialComponent)}l.push(w[0].results[Q].BillOfMaterialComponent)}f=[];m=[];g=[];p=[];P($.sap.brk,s,l)}}).catch(function(e){i.close();var t=JSON.parse(e.responseText);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){return}}})})};P($.sap.brk,M,M)},onGoSales:function(){i.open();var e=this;sap.m.MessageBox.show(" Do you want to proceed?.",{icon:sap.m.MessageBox.Icon.INFORMATION,title:"Search BOM",actions:["OK","Cancel"],onClose:function(t){if(t==="OK"){e.onSalesBOMSearch()}if(t==="Cancel"){i.close()}},initialFocus:"OK"})},onSalesBOMSearch:function(){var e=this.getView().byId("salesInput").getValue();if(e.length===0){sap.m.MessageBox.warning("Please enter all mandatory fields.");i.close()}else{this.onSalesSearch()}},onSalesSearch:function(){var e=this.getView().byId("salesInput").getValue(),t=new sap.ui.model.json.JSONModel,a=this.getView().getModel("modelB"),r=this.getView().getModel("modelA"),s=this;this.getView().setModel(t,"SAM");a.read("/A_SalesOrderItem",{urlParameters:{$select:"SalesOrder,SalesOrderItem,Material,RequestedQuantity,SalesOrderItemText,SalesOrderItemCategory,ProductionPlant",$filter:"(SalesOrder eq '"+e+"')",$orderby:"SalesOrderItem"},async:false,success:function(e){if(e.results.length===0){i.close();s.getView().byId("salesInput").setValue("");sap.m.MessageToast.show("No Records Found");return}var a=[];for(var l=0;l<e.results.length;l++){a.push({SalesOrder:e.results[l].SalesOrder,SalesOrderItem:e.results[l].SalesOrderItem,Material:e.results[l].Material,RequestedQuantity:e.results[l].RequestedQuantity,SalesOrderItemText:e.results[l].SalesOrderItemText,SalesOrderItemCategory:e.results[l].SalesOrderItemCategory,ProductionPlant:e.results[l].ProductionPlant,StandardCost:"",CalculatedStdCost:""})}var o=[];var n=[];var u=[];var d=[];var c=[];var f=e.results[0].ProductionPlant;$.sap.gplant=f;for(var m=0;m<e.results.length;m++){u[m]=e.results[m].Material}for(var p=0;p<u.length;p++){d.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.EQ,u[p]),new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,f),new sap.ui.model.Filter("BillOfMaterialVariantUsage",sap.ui.model.FilterOperator.EQ,"1")],and:true}));o.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Product",sap.ui.model.FilterOperator.EQ,u[p]),new sap.ui.model.Filter("ValuationArea",sap.ui.model.FilterOperator.EQ,f)],and:true}))}n.push(new sap.ui.model.Filter({filters:o,and:false}));c.push(new sap.ui.model.Filter({filters:d,and:false}));var g=s.getView().getModel();var h=function(e,t,a){return new Promise(function(s,l){g.read(e,{filters:c,urlParameters:{$select:"Material,BillOfMaterialVariantUsage,BillOfMaterial"},async:false,success:function(e){var i=[],o=[];$.sap.gmaterial=e.results;for(p=0;p<e.results.length;p++){i.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.EQ,e.results[p].Material),new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,f)],and:true}))}o.push(new sap.ui.model.Filter({filters:i,and:false}));g.read(t,{filters:o,urlParameters:{$select:"BillOfMaterialComponent,IsAssembly,Material,BillOfMaterialItemNumber",$orderby:"BillOfMaterialItemNumber"},async:false,success:function(t){var i=[];for(var o=0;o<t.results.length;o++){i.push({Material:t.results[o].Material,BillOfMaterialComponent:t.results[o].BillOfMaterialComponent,StandardPrice:""})}var n=[],u=[];for(p=0;p<t.results.length;p++){n.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Product",sap.ui.model.FilterOperator.EQ,t.results[p].BillOfMaterialComponent),new sap.ui.model.Filter("ValuationArea",sap.ui.model.FilterOperator.EQ,f)],and:true}))}u.push(new sap.ui.model.Filter({filters:n,and:false}));r.read(a,{filters:u,urlParameters:{$select:"StandardPrice,Product"},async:false,success:function(t){for(p=0;p<i.length;p++){for(var a=0;a<t.results.length;a++){if(i[p].BillOfMaterialComponent===t.results[a].Product){i[p].StandardPrice=t.results[a].StandardPrice}}}var r=0,l=[];for(p=0;p<e.results.length;p++){for(a=0;a<i.length;a++){if(e.results[p].Material===i[a].Material){r=r+parseFloat(i[a].StandardPrice)}}l.push({Material:e.results[p].Material,CalculatedSPwQ:r});r=0}s(l)},error:function(e){l(e)}})},error:function(e){l(e)}})},error:function(e){l(e)}})})};var M=function(e){return new Promise(function(t,a){r.read(e,{filters:n,urlParameters:{$select:"StandardPrice,Product,ValuationArea,PriceUnitQty"},async:false,success:function(e){t(e)},error:function(e){a(e)}})})};Promise.all([h("/MaterialBOM","/MaterialBOMItem","/A_ProductValuation"),M("/A_ProductValuation")]).then(function(e){for(p=0;p<a.length;p++){for(var r=0;r<e[1].results.length;r++){if(a[p].Material===e[1].results[r].Product){a[p].StandardCost=e[1].results[r].StandardPrice;a[p].CalculatedStdCost=parseFloat(e[1].results[r].StandardPrice*a[p].RequestedQuantity).toFixed(3);r=e[1].results.length-1}}}for(p=0;p<a.length;p++){for(r=0;r<e[0].length;r++){if(a[p].Material===e[0][r].Material){a[p].CalculatedStdCost=parseFloat(e[0][r].CalculatedSPwQ*a[p].RequestedQuantity).toFixed(3)}}}t=new sap.ui.model.json.JSONModel;t.setSizeLimit(a.length);t.setData(a);$.sap.sviewdata=JSON.parse(JSON.stringify(a));i.close();s.getView().setModel(t,"SAM")}).catch(function(e){})},error:function(e){}})},onSalesexcel:function(){var e=new sap.ui.model.json.JSONModel;this.getView().setModel(e,"XLSX");var t=0,a=[],r=false,s,l,o=[],n=true,u=0,d=[],c=[],f=[],m=[],p=[],g=0;var h=[];for(var M=0;M<$.sap.gmaterial.length;M++){h[M]=$.sap.gmaterial[M].Material}var w=$.sap.gplant;var S=this.getView().getModel("modelA");var O=this.getView().getModel();$.sap.brk=O;var v=this;var P=function(O,F,y){for(M=0;M<F.length;M++){c.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.EQ,F[M]),new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,w)],and:true}))}f.push(new sap.ui.model.Filter({filters:c,and:false}));for(M=0;M<y.length;M++){p.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Product",sap.ui.model.FilterOperator.EQ,y[M]),new sap.ui.model.Filter("ValuationArea",sap.ui.model.FilterOperator.EQ,w)],and:true}))}m.push(new sap.ui.model.Filter({filters:p,and:false}));var V=function(e){return new Promise(function(t,a){if(F.length===0){t("")}else{O.read(e,{filters:f,urlParameters:{$select:"BillOfMaterialComponent,IsAssembly,Material,BillOfMaterialItemNumber,ComponentDescription,BillOfMaterialItemQuantity",$orderby:"BillOfMaterialItemNumber"},async:false,success:function(e){if(e.results.length===0){i.close();sap.m.MessageToast.show("No Records Found");return}t(e)},error:function(e){a(e)}})}})},I=function(e){return new Promise(function(t,a){S.read(e,{filters:m,urlParameters:{$select:"StandardPrice,Product,ValuationArea,PriceUnitQty"},async:false,success:function(e){t(e)},error:function(e){a(e)}})})};Promise.all([V("/MaterialBOMItem"),I("/A_ProductValuation")]).then(function(w){if(w[0]===""){for(M=0;M<w[1].results.length;M++){a.push(w[1].results[M])}for(M=0;M<o.length;M++){for(var S=0;S<a.length;S++){if(o[M].Material===a[S].Product){o[M].StandardCost=a[S].StandardPrice;o[M].psc=parseFloat(a[S].StandardPrice/a[S].PriceUnitQty).toFixed(3);o[M].CalculatedStdCost=parseFloat(o[M].RequestedQuantity*(a[S].StandardPrice/a[S].PriceUnitQty)).toFixed(3)}}}var O=JSON.parse(JSON.stringify($.sap.sviewdata));for(var F=0;F<O.length;F++){for(var y=0;y<o.length;y++){if(O[F].Material===o[y].mat){t+=1;O.splice(F+t,0,o[y])}}t=0}e=new sap.ui.model.json.JSONModel;e.setSizeLimit(O.length);e.setData(O);v.getView().setModel(e,"XLSX");i.close();v.onSalesExcelDownload(v)}else{g+=1;for(var V=0;V<w[0].results.length;V++){u+=1;d.push({mat:w[0].results[V].Material,itm:w[0].results[V].BillOfMaterialItemNumber,Material:w[0].results[V].BillOfMaterialComponent,asm:w[0].results[V].IsAssembly,SalesOrderItemText:w[0].results[V].ComponentDescription,RequestedQuantity:w[0].results[V].BillOfMaterialItemQuantity,StandardCost:"",psc:"",CalculatedStdCost:"",msp:"",lvl:g,idx:u})}for(M=0;M<w[1].results.length;M++){a.push(w[1].results[M])}if(n){for(var I=0;I<h.length;I++){for(var b=0;b<d.length;b++){if(h[I]===d[b].mat){o.push(d[b])}}}}if(r){for(F=0;F<o.length;F++){for(y=0;y<d.length;y++){if(o[F].asm.length>0){if(o[F].Material===d[y].mat){t+=1;o.splice(F+t,0,d[y])}}}t=0}}d=[];n=false;r=true;s=[];l=[];for(var B=0;B<w[0].results.length;B++){if(w[0].results[B].IsAssembly.length>0){s.push(w[0].results[B].BillOfMaterialComponent)}l.push(w[0].results[B].BillOfMaterialComponent)}c=[];f=[];p=[];m=[];P($.sap.brk,s,l)}}).catch(function(e){i.close();var t=JSON.parse(e.responseText);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){return}}})})};P($.sap.brk,h,h)},salesonDataExport:function(){i.open();this.onSalesexcel()}})});