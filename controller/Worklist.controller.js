sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/IconPool"],function(e,t,a,r,s,l){"use strict";var i=new sap.m.BusyDialog,o=sap.ui.core.format.NumberFormat.getFloatInstance({maxFractionDigits:3,decimalSeparator:",",groupingEnabled:true}),n;return e.extend("com.salesbom.culligan.salesbomdisplay.controller.Worklist",{formatter:a,onInit:function(){var e=new t({worklistTableTitle:this.getResourceBundle().getText("worklistTableTitle"),bomMaterialTableCount:""});this.getView().setModel(e,"worklistView");var a=new t({salesTableTitle:this.getResourceBundle().getText("salesTableTitle"),salesOrderTableCount:""});this.getView().setModel(a,"salesView");var r=[];var s={};var i={fontFamily:"SAP-icons-TNT",fontURI:sap.ui.require.toUrl("sap/tnt/themes/base/fonts/")};l.registerFont(i);r.push(l.fontLoaded("SAP-icons-TNT"));s["SAP-icons-TNT"]=i},matonDataExport:function(){this.onExcelDownload(this)},onSalesFinished:function(e){var t,a=e.getSource(),r=e.getParameter("total");if(r&&a.getBinding("items").isLengthFinal()){t=this.getResourceBundle().getText("salesTableTitleCount",[r])}else{t=this.getResourceBundle().getText("salesTableTitle")}this.getView().getModel("salesView").setProperty("/salesTableTitle",t);this.getView().getModel("salesView").setProperty("/salesOrderTableCount",[r])},onSearch:function(e){if(e.getParameters().refreshButtonPressed){this.onRefresh()}else{var t=[];var a=e.getParameter("query");if(a&&a.length>0){var r=sap.ui.model.FilterOperator.Contains;t=[new sap.ui.model.Filter([new sap.ui.model.Filter("bom",r,a)],false)]}this._applySearch(t)}},onSaleslocalSearch:function(e){if(e.getParameters().refreshButtonPressed){this.onSalesRefresh()}else{var t=[];var a=e.getParameter("query");if(a&&a.length>0){var r=sap.ui.model.FilterOperator.Contains;t=[new sap.ui.model.Filter([new sap.ui.model.Filter("Material",r,a)],false)]}this._applySalesSearch(t)}},_applySalesSearch:function(e){var t=this.getView().byId("tab");t.getBinding("items").filter(e,"Application")},_applySearch:function(e){var t=this.getView().byId("mattab");t.getBinding("items").filter(e,"Application")},onRefresh:function(){var e=this.getView().byId("mattab");e.getBinding("items").refresh()},onSalesRefresh:function(){var e=this.getView().byId("tab");e.getBinding("items").refresh()},onClear:function(){var e=this.getView().byId("matbtnId");var t=e.getAllFilterItems(true);e.determineControlByFilterItem(t[0]).setValue("");e.determineControlByFilterItem(t[1]).setValue("")},onSalesFilterClear:function(){var e=this.getView().byId("btnId");var t=e.getAllFilterItems(true);e.determineControlByFilterItem(t[0]).setValue("")},onUpdateFinished:function(e){var t,a=e.getSource(),r=e.getParameter("total");if(r&&a.getBinding("items").isLengthFinal()){t=this.getResourceBundle().getText("worklistTableTitleCount",[r])}else{t=this.getResourceBundle().getText("worklistTableTitle")}this.getView().getModel("worklistView").setProperty("/worklistTableTitle",t);this.getView().getModel("worklistView").setProperty("/bomMaterialTableCount",[r])},onLiveChange:function(e){var t=e.getSource().getValue();this.getView().byId("matidPlant").setValue(t.toUpperCase())},matonGo:function(){i.open();var e=this;sap.m.MessageBox.show(" Do you want to proceed?.",{icon:sap.m.MessageBox.Icon.INFORMATION,title:"Search BOM",actions:["OK","Cancel"],onClose:function(t){if(t==="OK"){e.onBOMSearch()}if(t==="Cancel"){i.close()}},initialFocus:"OK"})},onBOMSearch:function(){var e=this.getView().byId("matmultiInput").getValue();var t=this.getView().byId("matidPlant").getValue().toString();if(e.length===0||t.length===0){sap.m.MessageBox.warning("Please enter all mandatory fields.");i.close()}else{this.connectServer()}},connectServer:function(){var e=new sap.ui.model.json.JSONModel;this.getView().setModel(e,"BRF");var t=0,a=[],r=false,s,l,o=[],n=true,u=0,d=[],c=[],f=[],m=[],p=[],g=0;var h=[this.getView().byId("matmultiInput").getValue()];var S=this.getView().byId("matidPlant").getValue().toString();var M=this.getView().getModel("modelA");var w=this.getView().getModel();$.sap.brk=w;var O=this;var v=function(w,P,F){for(var y=0;y<P.length;y++){c.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.EQ,P[y]),new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,S)],and:true}))}f.push(new sap.ui.model.Filter({filters:c,and:false}));for(y=0;y<F.length;y++){p.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Product",sap.ui.model.FilterOperator.EQ,F[y]),new sap.ui.model.Filter("ValuationArea",sap.ui.model.FilterOperator.EQ,S)],and:true}))}m.push(new sap.ui.model.Filter({filters:p,and:false}));var C=function(e){return new Promise(function(t,a){if(P.length===0){t("")}else{w.read(e,{filters:f,urlParameters:{$select:"BillOfMaterialComponent,IsAssembly,Material,BillOfMaterialItemNumber,ComponentDescription,BillOfMaterialItemQuantity",$orderby:"BillOfMaterialItemNumber"},async:false,success:function(e){if(e.results.length===0){i.close();O.getView().byId("matmultiInput").setValue("");O.getView().byId("matidPlant").setValue("");O.getView().byId("matidSC").setValue("");O.getView().byId("matidBOM").setValue("");O.getView().byId("matidPSC").setValue("");O.getView().byId("matidDiff").setValue("");O.getView().byId("matidTSC").setValue("");sap.m.MessageToast.show("No Records Found");return}t(e)},error:function(e){a(e)}})}})},V=function(e){return new Promise(function(t,a){if(P.length===0){t("")}else{w.read(e,{filters:f,urlParameters:{$select:"BillOfMaterialVariantUsage,Material"},async:false,success:function(e){t(e)},error:function(e){a(e)}})}})},I=function(e){return new Promise(function(t,a){M.read(e,{filters:m,urlParameters:{$select:"StandardPrice,Product,ValuationArea,PriceUnitQty"},async:false,success:function(e){t(e)},error:function(e){a(e)}})})};Promise.all([C("/MaterialBOMItem"),V("/MaterialBOM"),I("/A_ProductValuation")]).then(function(S){if(S[0]===""&&S[1]===""){for(y=0;y<S[2].results.length;y++){a.push(S[2].results[y])}for(y=0;y<o.length;y++){for(var M=0;M<a.length;M++){if(o[y].bom===a[M].Product){o[y].stc=a[M].StandardPrice;o[y].psc=parseFloat(a[M].StandardPrice/a[M].PriceUnitQty).toFixed(3);o[y].tsc=parseFloat(o[y].qty*(a[M].StandardPrice/a[M].PriceUnitQty)).toFixed(3)}}}var w=0;for(M=0;M<o.length;M++){if(o[M].lvl===1){w=w+parseFloat(o[M].tsc)}}var P=w-$.sap.spc;var F=JSON.parse(JSON.stringify(o));F[0].msp=$.sap.spc;var C=new sap.ui.model.json.JSONModel;C.setSizeLimit(F.length);C.setData(F);O.getView().setModel(C,"OPM");i.close();e=new sap.ui.model.json.JSONModel;e.setSizeLimit(o.length);e.setData(o);O.getView().byId("matidBOM").setValue($.sap.usg);O.getView().byId("matidSC").setValue($.sap.spc);O.getView().byId("matidPSC").setValue($.sap.psc);O.getView().byId("matidTSC").setValue(w);O.getView().byId("matidDiff").setValue(parseFloat(P).toFixed(3));O.getView().setModel(e,"BRF")}else{g+=1;for(var V=0;V<S[0].results.length;V++){for(var I=0;I<S[1].results.length;I++){if(S[0].results[V].Material===S[1].results[I].Material){u+=1;d.push({mat:S[0].results[V].Material,itm:S[0].results[V].BillOfMaterialItemNumber,bom:S[0].results[V].BillOfMaterialComponent,asm:S[0].results[V].IsAssembly,des:S[0].results[V].ComponentDescription,qty:S[0].results[V].BillOfMaterialItemQuantity,usg:S[1].results[I].BillOfMaterialVariantUsage,stc:"",psc:"",tsc:"",msp:"",lvl:g,idx:u})}}}for(y=0;y<S[2].results.length;y++){a.push(S[2].results[y])}if(n){$.sap.usg=S[1].results[0].BillOfMaterialVariantUsage;$.sap.spc=S[2].results[0].StandardPrice;$.sap.psc=parseFloat(S[2].results[0].StandardPrice/S[2].results[0].PriceUnitQty).toFixed(3);for(var B=0;B<h.length;B++){for(var b=0;b<d.length;b++){if(h[B]===d[b].mat){o.push(d[b])}}}}if(r){for(var T=0;T<o.length;T++){for(var x=0;x<d.length;x++){if(o[T].asm.length>0){if(o[T].bom===d[x].mat){t+=1;o.splice(T+t,0,d[x])}}}t=0}}d=[];n=false;r=true;s=[];l=[];for(var N=0;N<S[0].results.length;N++){if(S[0].results[N].IsAssembly.length>0){s.push(S[0].results[N].BillOfMaterialComponent)}l.push(S[0].results[N].BillOfMaterialComponent)}c=[];f=[];p=[];m=[];v($.sap.brk,s,l)}}).catch(function(e){i.close();var t=JSON.parse(e.responseText);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){return}}})})};v($.sap.brk,h,h)},onGoSales:function(){i.open();var e=this;sap.m.MessageBox.show(" Do you want to proceed?.",{icon:sap.m.MessageBox.Icon.INFORMATION,title:"Search BOM",actions:["OK","Cancel"],onClose:function(t){if(t==="OK"){e.onSalesBOMSearch()}if(t==="Cancel"){i.close()}},initialFocus:"OK"})},onSalesBOMSearch:function(){var e=this.getView().byId("salesInput").getValue();if(e.length===0){sap.m.MessageBox.warning("Please enter all mandatory fields.");i.close()}else{this.onSalesSearch()}},onSalesSearch:function(){var e=this.getView().byId("salesInput").getValue(),t=new sap.ui.model.json.JSONModel,a=this.getView().getModel("modelB"),r=this.getView().getModel("modelA"),s=this;this.getView().setModel(t,"SAM");a.read("/A_SalesOrderItem",{urlParameters:{$select:"SalesOrder,SalesOrderItem,Material,RequestedQuantity,SalesOrderItemText,SalesOrderItemCategory,ProductionPlant,MaterialByCustomer",$filter:"(SalesOrder eq '"+e+"')",$orderby:"SalesOrderItem"},async:false,success:function(e){if(e.results.length===0){i.close();s.getView().byId("salesInput").setValue("");sap.m.MessageToast.show("No Records Found");return}var a=[];for(var l=0;l<e.results.length;l++){a.push({SalesOrder:e.results[l].SalesOrder,SalesOrderItem:e.results[l].SalesOrderItem,Material:e.results[l].Material,RequestedQuantity:e.results[l].RequestedQuantity,SalesOrderItemText:e.results[l].SalesOrderItemText,SalesOrderItemCategory:e.results[l].SalesOrderItemCategory,ProductionPlant:e.results[l].ProductionPlant,MaterialByCustomer:e.results[l].MaterialByCustomer,StandardCost:"",CalculatedStdCost:""})}var o=[];var u=[];var d=[];var c=[];var f=[];var m=e.results[0].ProductionPlant;if(m===""){m=e.results[1].ProductionPlant}$.sap.gplant=m;for(var p=0;p<e.results.length;p++){d[p]=e.results[p].Material}for(var g=0;g<d.length;g++){c.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.EQ,d[g]),new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,m),new sap.ui.model.Filter("BillOfMaterialVariantUsage",sap.ui.model.FilterOperator.EQ,"1")],and:true}));o.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Product",sap.ui.model.FilterOperator.EQ,d[g]),new sap.ui.model.Filter("ValuationArea",sap.ui.model.FilterOperator.EQ,m)],and:true}))}u.push(new sap.ui.model.Filter({filters:o,and:false}));f.push(new sap.ui.model.Filter({filters:c,and:false}));var h=s.getView().getModel();var S=function(e,t,a){return new Promise(function(s,l){h.read(e,{filters:f,urlParameters:{$select:"Material,BillOfMaterialVariantUsage,BillOfMaterial"},async:false,success:function(e){if(e.results.length===0){s("not1or5")}else{var i=[],o=[];$.sap.gmaterial=e.results;for(g=0;g<e.results.length;g++){i.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.EQ,e.results[g].Material),new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,m)],and:true}))}o.push(new sap.ui.model.Filter({filters:i,and:false}));h.read(t,{filters:o,urlParameters:{$select:"BillOfMaterialComponent,IsAssembly,Material,BillOfMaterialItemNumber",$orderby:"BillOfMaterialItemNumber"},async:false,success:function(t){var i=[];for(var o=0;o<t.results.length;o++){i.push({Material:t.results[o].Material,BillOfMaterialComponent:t.results[o].BillOfMaterialComponent,StandardPrice:""})}var n=[],u=[];for(g=0;g<t.results.length;g++){n.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Product",sap.ui.model.FilterOperator.EQ,t.results[g].BillOfMaterialComponent),new sap.ui.model.Filter("ValuationArea",sap.ui.model.FilterOperator.EQ,m)],and:true}))}u.push(new sap.ui.model.Filter({filters:n,and:false}));r.read(a,{filters:u,urlParameters:{$select:"StandardPrice,Product"},async:false,success:function(t){for(g=0;g<i.length;g++){for(var a=0;a<t.results.length;a++){if(i[g].BillOfMaterialComponent===t.results[a].Product){i[g].StandardPrice=t.results[a].StandardPrice}}}var r=0,l=[];for(g=0;g<e.results.length;g++){for(a=0;a<i.length;a++){if(e.results[g].Material===i[a].Material){r=r+parseFloat(i[a].StandardPrice)}}l.push({Material:e.results[g].Material,CalculatedSPwQ:r});r=0}s(l)},error:function(e){l(e)}})},error:function(e){l(e)}})}},error:function(e){l(e)}})})};var M=function(e){return new Promise(function(t,a){r.read(e,{filters:u,urlParameters:{$select:"StandardPrice,Product,ValuationArea,PriceUnitQty"},async:false,success:function(e){t(e)},error:function(e){a(e)}})})};Promise.all([S("/MaterialBOM","/MaterialBOMItem","/A_ProductValuation"),M("/A_ProductValuation")]).then(function(e){if(e[0]==="not1or5"){n=true;for(g=0;g<a.length;g++){for(var r=0;r<e[1].results.length;r++){if(a[g].Material===e[1].results[r].Product){a[g].StandardCost=e[1].results[r].StandardPrice;a[g].CalculatedStdCost=parseFloat(e[1].results[r].StandardPrice*a[g].RequestedQuantity).toFixed(3);r=e[1].results.length-1}}}for(var l=0;l<a.length;l++){if(a[l].SalesOrderItemCategory==="TAP"||a[l].SalesOrderItemCategory==="CBTP"){a[l].StandardCost="";a[l].CalculatedStdCost=""}if(parseFloat(a[l].StandardCost)===0||parseFloat(a[l].CalculatedStdCost)===0){a[l].StandardCost="";a[l].CalculatedStdCost=""}}t=new sap.ui.model.json.JSONModel;t.setSizeLimit(a.length);t.setData(a);i.close();s.getView().setModel(t,"SAM")}else{n=false;for(g=0;g<a.length;g++){for(r=0;r<e[1].results.length;r++){if(a[g].Material===e[1].results[r].Product){a[g].StandardCost=e[1].results[r].StandardPrice;a[g].CalculatedStdCost=parseFloat(e[1].results[r].StandardPrice*a[g].RequestedQuantity).toFixed(3);r=e[1].results.length-1}}}for(g=0;g<a.length;g++){for(r=0;r<e[0].length;r++){if(a[g].Material===e[0][r].Material){a[g].CalculatedStdCost=parseFloat(e[0][r].CalculatedSPwQ*a[g].RequestedQuantity).toFixed(3)}}}for(l=0;l<a.length;l++){if(a[l].SalesOrderItemCategory==="TAP"||a[l].SalesOrderItemCategory==="CBTP"){a[l].StandardCost="";a[l].CalculatedStdCost=""}if(parseFloat(a[l].StandardCost)===0||parseFloat(a[l].CalculatedStdCost)===0){a[l].StandardCost="";a[l].CalculatedStdCost=""}}t=new sap.ui.model.json.JSONModel;t.setSizeLimit(a.length);t.setData(a);$.sap.sviewdata=JSON.parse(JSON.stringify(a));i.close();s.getView().setModel(t,"SAM")}}).catch(function(e){i.close();var t=JSON.parse(e.responseText);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){return}}})})},error:function(e){i.close();var t=JSON.parse(e.responseText);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){return}}})}})},onNewxls:function(){var e=new sap.ui.model.json.JSONModel;var t=this.getView().getModel("SAM").getData();e.setData(t);this.getView().setModel(e,"XLSX");i.close();this.onSalesExcelDownload(this)},onSalesexcel:function(){var e=new sap.ui.model.json.JSONModel;this.getView().setModel(e,"XLSX");var t=0,a=[],r=false,s,l,o=[],n=true,u=0,d=[],c=[],f=[],m=[],p=[],g=0;var h=[];for(var S=0;S<$.sap.gmaterial.length;S++){h[S]=$.sap.gmaterial[S].Material}var M=$.sap.gplant;var w=this.getView().getModel("modelA");var O=this.getView().getModel();$.sap.brk=O;var v=this;var P=function(O,F,y){for(S=0;S<F.length;S++){c.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.EQ,F[S]),new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,M)],and:true}))}f.push(new sap.ui.model.Filter({filters:c,and:false}));for(S=0;S<y.length;S++){p.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Product",sap.ui.model.FilterOperator.EQ,y[S]),new sap.ui.model.Filter("ValuationArea",sap.ui.model.FilterOperator.EQ,M)],and:true}))}m.push(new sap.ui.model.Filter({filters:p,and:false}));var C=function(e){return new Promise(function(t,a){if(F.length===0){t("")}else{O.read(e,{filters:f,urlParameters:{$select:"BillOfMaterialComponent,IsAssembly,Material,BillOfMaterialItemNumber,ComponentDescription,BillOfMaterialItemQuantity",$orderby:"BillOfMaterialItemNumber"},async:false,success:function(e){if(e.results.length===0){i.close();sap.m.MessageToast.show("No Records Found");return}t(e)},error:function(e){a(e)}})}})},V=function(e){return new Promise(function(t,a){w.read(e,{filters:m,urlParameters:{$select:"StandardPrice,Product,ValuationArea,PriceUnitQty"},async:false,success:function(e){t(e)},error:function(e){a(e)}})})};Promise.all([C("/MaterialBOMItem"),V("/A_ProductValuation")]).then(function(M){if(M[0]===""){for(S=0;S<M[1].results.length;S++){a.push(M[1].results[S])}for(S=0;S<o.length;S++){for(var w=0;w<a.length;w++){if(o[S].Material===a[w].Product){o[S].StandardCost=a[w].StandardPrice;o[S].CalculatedStdCost=parseFloat(o[S].RequestedQuantity*(a[w].StandardPrice/a[w].PriceUnitQty)).toFixed(3)}}}var O=JSON.parse(JSON.stringify($.sap.sviewdata));for(var F=0;F<O.length;F++){for(var y=0;y<o.length;y++){if(O[F].Material===o[y].mat){t+=1;O.splice(F+t,0,o[y])}}t=0}e=new sap.ui.model.json.JSONModel;e.setSizeLimit(O.length);e.setData(O);v.getView().setModel(e,"XLSX");i.close();v.onSalesExcelDownload(v)}else{g+=1;for(var C=0;C<M[0].results.length;C++){u+=1;d.push({mat:M[0].results[C].Material,itm:M[0].results[C].BillOfMaterialItemNumber,Material:M[0].results[C].BillOfMaterialComponent,asm:M[0].results[C].IsAssembly,SalesOrderItemText:M[0].results[C].ComponentDescription,RequestedQuantity:M[0].results[C].BillOfMaterialItemQuantity,StandardCost:"",CalculatedStdCost:"",lvl:g,idx:u})}for(S=0;S<M[1].results.length;S++){a.push(M[1].results[S])}if(n){for(var V=0;V<h.length;V++){for(var I=0;I<d.length;I++){if(h[V]===d[I].mat){o.push(d[I])}}}}if(r){for(F=0;F<o.length;F++){for(y=0;y<d.length;y++){if(o[F].asm.length>0){if(o[F].Material===d[y].mat){t+=1;o.splice(F+t,0,d[y])}}}t=0}}d=[];n=false;r=true;s=[];l=[];for(var B=0;B<M[0].results.length;B++){l.push(M[0].results[B].BillOfMaterialComponent)}c=[];f=[];p=[];m=[];P($.sap.brk,s,l)}}).catch(function(e){i.close();var t=JSON.parse(e.responseText);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){return}}})})};P($.sap.brk,h,h)},salesonDataExport:function(){i.open();if(n===true){this.onNewxls()}else if(n===false){this.onSalesexcel()}else{i.close();return}}})});