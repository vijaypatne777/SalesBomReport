sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(e,t,a,s,r){"use strict";var l=new sap.m.BusyDialog;var i=sap.ui.core.format.NumberFormat.getFloatInstance({maxFractionDigits:3,decimalSeparator:",",groupingEnabled:true});return e.extend("com.salesbom.culligan.salesbomdisplay.controller.Worklist",{formatter:a,onInit:function(){var e=new t({worklistTableTitle:this.getResourceBundle().getText("worklistTableTitle")});this.getView().setModel(e,"worklistView");var a=new t({salesTableTitle:this.getResourceBundle().getText("salesTableTitle")});this.getView().setModel(a,"salesView")},matonDataExport:function(){this.onExcelDownload(this)},onSalesFinished:function(e){var t,a=e.getSource(),s=e.getParameter("total");if(s&&a.getBinding("items").isLengthFinal()){t=this.getResourceBundle().getText("salesTableTitleCount",[s])}else{t=this.getResourceBundle().getText("salesTableTitle")}this.getView().getModel("salesView").setProperty("/salesTableTitle",t)},onSearch:function(e){if(e.getParameters().refreshButtonPressed){this.onRefresh()}else{var t=[];var a=e.getParameter("query");if(a&&a.length>0){var s=sap.ui.model.FilterOperator.Contains;t=[new sap.ui.model.Filter([new sap.ui.model.Filter("bom",s,a)],false)]}this._applySearch(t)}},_applySearch:function(e){var t=this.getView().byId("mattab");t.getBinding("items").filter(e,"Application")},onRefresh:function(){var e=this.getView().byId("mattab");e.getBinding("items").refresh()},onClear:function(){var e=this.getView().byId("matbtnId");var t=e.getAllFilterItems(true);e.determineControlByFilterItem(t[0]).setValue("");e.determineControlByFilterItem(t[1]).setValue("")},onUpdateFinished:function(e){var t,a=e.getSource(),s=e.getParameter("total");if(s&&a.getBinding("items").isLengthFinal()){t=this.getResourceBundle().getText("worklistTableTitleCount",[s])}else{t=this.getResourceBundle().getText("worklistTableTitle")}this.getView().getModel("worklistView").setProperty("/worklistTableTitle",t)},onLiveChange:function(e){var t=e.getSource().getValue();this.getView().byId("matidPlant").setValue(t.toUpperCase())},matonGo:function(){l.open();var e=this;sap.m.MessageBox.show(" Do you want to proceed?.",{icon:sap.m.MessageBox.Icon.INFORMATION,title:"Search BOM",actions:["OK","Cancel"],onClose:function(t){if(t==="OK"){e.onBOMSearch()}if(t==="Cancel"){l.close()}},initialFocus:"OK"})},onBOMSearch:function(){var e=this.getView().byId("matmultiInput").getValue();var t=this.getView().byId("matidPlant").getValue().toString();if(e.length===0||t.length===0){sap.m.MessageBox.warning("Please enter all mandatory fields.");l.close()}else{this.connectServer()}},connectServer:function(){var e=new sap.ui.model.json.JSONModel;this.getView().setModel(e,"BRF");var t=0,a=[],s=false,r,o,n=[],u=true,c=0,d=[],m=[],g=[],f=[],p=[],h=0;var w=[this.getView().byId("matmultiInput").getValue()];var M=this.getView().byId("matidPlant").getValue().toString();var O=this.getView().getModel("modelA");var S=this.getView().getModel();$.sap.brk=S;var V=this;var v=function(S,B,y){for(var F=0;F<B.length;F++){m.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.EQ,B[F]),new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,M)],and:true}))}g.push(new sap.ui.model.Filter({filters:m,and:false}));for(F=0;F<y.length;F++){p.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Product",sap.ui.model.FilterOperator.EQ,y[F]),new sap.ui.model.Filter("ValuationArea",sap.ui.model.FilterOperator.EQ,M)],and:true}))}f.push(new sap.ui.model.Filter({filters:p,and:false}));var b=function(e){return new Promise(function(t,a){if(B.length===0){t("")}else{S.read(e,{filters:g,urlParameters:{$select:"BillOfMaterialComponent,IsAssembly,Material,BillOfMaterialItemNumber,ComponentDescription,BillOfMaterialItemQuantity",$orderby:"BillOfMaterialItemNumber"},async:false,success:function(e){if(e.results.length===0){l.close();V.getView().byId("matidBOM").setValue("");V.getView().byId("matidSC").setValue("");sap.m.MessageToast.show("No Records Found");return}t(e)},error:function(e){a(e)}})}})},I=function(e){return new Promise(function(t,a){if(B.length===0){t("")}else{S.read(e,{filters:g,urlParameters:{$select:"BillOfMaterialVariantUsage,Material"},async:false,success:function(e){t(e)},error:function(e){a(e)}})}})},P=function(e){return new Promise(function(t,a){O.read(e,{filters:f,urlParameters:{$select:"StandardPrice,Product,ValuationArea,PriceUnitQty"},async:false,success:function(e){t(e)},error:function(e){a(e)}})})};Promise.all([b("/MaterialBOMItem"),I("/MaterialBOM"),P("/A_ProductValuation")]).then(function(M){if(M[0]===""&&M[1]===""){for(F=0;F<M[2].results.length;F++){a.push(M[2].results[F])}for(F=0;F<n.length;F++){for(var O=0;O<a.length;O++){if(n[F].bom===a[O].Product){n[F].stc=a[O].StandardPrice;n[F].psc=parseFloat(a[O].StandardPrice/a[O].PriceUnitQty).toFixed(2);n[F].tsc=parseFloat(n[F].qty*(a[O].StandardPrice/a[O].PriceUnitQty)).toFixed(3)}}}var S=JSON.parse(JSON.stringify(n));S[0].msp=i.format($.sap.spc);for(F=0;F<S.length;F++){S[F].stc=i.format(S[F].stc);S[F].psc=i.format(S[F].psc);S[F].tsc=i.format(S[F].tsc)}var B=new sap.ui.model.json.JSONModel;B.setSizeLimit(S.length);B.setData(S);V.getView().setModel(B,"OPM");l.close();e=new sap.ui.model.json.JSONModel;e.setSizeLimit(n.length);e.setData(n);V.getView().byId("matidBOM").setValue($.sap.usg);V.getView().byId("matidSC").setValue($.sap.spc);V.getView().byId("matidPSC").setValue($.sap.psc);V.getView().setModel(e,"BRF")}else{h+=1;for(var y=0;y<M[0].results.length;y++){for(var b=0;b<M[1].results.length;b++){if(M[0].results[y].Material===M[1].results[b].Material){c+=1;d.push({mat:M[0].results[y].Material,itm:M[0].results[y].BillOfMaterialItemNumber,bom:M[0].results[y].BillOfMaterialComponent,asm:M[0].results[y].IsAssembly,des:M[0].results[y].ComponentDescription,qty:M[0].results[y].BillOfMaterialItemQuantity,usg:M[1].results[b].BillOfMaterialVariantUsage,stc:"",psc:"",tsc:"",msp:"",lvl:h,idx:c})}}}for(F=0;F<M[2].results.length;F++){a.push(M[2].results[F])}if(u){$.sap.usg=M[1].results[0].BillOfMaterialVariantUsage;$.sap.spc=M[2].results[0].StandardPrice;$.sap.psc=parseFloat(M[2].results[0].StandardPrice/M[2].results[0].PriceUnitQty).toFixed(3);for(var I=0;I<w.length;I++){for(var P=0;P<d.length;P++){if(w[I]===d[P].mat){n.push(d[P])}}}}if(s){for(var T=0;T<n.length;T++){for(var C=0;C<d.length;C++){if(n[T].asm.length>0){if(n[T].bom===d[C].mat){t+=1;n.splice(T+t,0,d[C])}}}t=0}}d=[];u=false;s=true;r=[];o=[];for(var x=0;x<M[0].results.length;x++){if(M[0].results[x].IsAssembly.length>0){r.push(M[0].results[x].BillOfMaterialComponent)}o.push(M[0].results[x].BillOfMaterialComponent)}m=[];g=[];p=[];f=[];v($.sap.brk,r,o)}}).catch(function(e){l.close();var t=JSON.parse(e.responseText);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){return}}})})};v($.sap.brk,w,w)},onGoSales:function(){l.open();var e=this;sap.m.MessageBox.show(" Do you want to proceed?.",{icon:sap.m.MessageBox.Icon.INFORMATION,title:"Search BOM",actions:["OK","Cancel"],onClose:function(t){if(t==="OK"){e.onSalesBOMSearch()}if(t==="Cancel"){l.close()}},initialFocus:"OK"})},onSalesBOMSearch:function(){var e=this.getView().byId("salesInput").getValue();if(e.length===0){sap.m.MessageBox.warning("Please enter all mandatory fields.");l.close()}else{this.onSalesSearch()}},onSalesSearch:function(){var e=this.getView().byId("salesInput").getValue(),t=new sap.ui.model.json.JSONModel,a=this.getView().getModel("modelB"),s=this;this.getView().setModel(t,"SAM");a.read("/A_SalesOrderItem",{urlParameters:{$select:"SalesOrder,SalesOrderItem,Material,RequestedQuantity,ProductionPlant,SalesOrderItemText,SalesOrderItemCategory,ProductionPlant",$filter:"(SalesOrder eq '"+e+"')",$orderby:"SalesOrderItem"},async:false,success:function(e){t=new sap.ui.model.json.JSONModel;t.setSizeLimit(e.results.length);t.setData(e.results);l.close();s.getView().setModel(t,"SAM");var a=[];var r=[];var i=[];var o=e.results[0].ProductionPlant;for(var n=0;n<e.results.length;n++){a[n]=e.results[n].Material}for(var u=0;u<a.length;u++){r.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.EQ,a[u]),new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,o),new sap.ui.model.Filter("BillOfMaterialVariantUsage",sap.ui.model.FilterOperator.EQ,"1")],and:true}))}i.push(new sap.ui.model.Filter({filters:r,and:false}));var c=s.getView().getModel();c.read("/MaterialBOM",{filters:i,urlParameters:{$select:"Material,BillOfMaterialVariantUsage,BillOfMaterial"},async:false,success:function(e){for(var t=0;t<e.results.length;t++){}},error:function(){}})},error:function(e){}})}})});