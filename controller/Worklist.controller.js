sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/IconPool"],function(e,t,a,r,s,l){"use strict";var i=new sap.m.BusyDialog;var o=sap.ui.core.format.NumberFormat.getFloatInstance({maxFractionDigits:3,decimalSeparator:",",groupingEnabled:true});return e.extend("com.salesbom.culligan.salesbomdisplay.controller.Worklist",{formatter:a,onInit:function(){var e=new t({worklistTableTitle:this.getResourceBundle().getText("worklistTableTitle"),bomMaterialTableCount:""});this.getView().setModel(e,"worklistView");var a=new t({salesTableTitle:this.getResourceBundle().getText("salesTableTitle"),salesOrderTableCount:""});this.getView().setModel(a,"salesView");var r=[];var s={};var i={fontFamily:"SAP-icons-TNT",fontURI:sap.ui.require.toUrl("sap/tnt/themes/base/fonts/")};l.registerFont(i);r.push(l.fontLoaded("SAP-icons-TNT"));s["SAP-icons-TNT"]=i},matonDataExport:function(){this.onExcelDownload(this)},onSalesFinished:function(e){var t,a=e.getSource(),r=e.getParameter("total");if(r&&a.getBinding("items").isLengthFinal()){t=this.getResourceBundle().getText("salesTableTitleCount",[r])}else{t=this.getResourceBundle().getText("salesTableTitle")}this.getView().getModel("salesView").setProperty("/salesTableTitle",t);this.getView().getModel("salesView").setProperty("/salesOrderTableCount",[r])},onSearch:function(e){if(e.getParameters().refreshButtonPressed){this.onRefresh()}else{var t=[];var a=e.getParameter("query");if(a&&a.length>0){var r=sap.ui.model.FilterOperator.Contains;t=[new sap.ui.model.Filter([new sap.ui.model.Filter("bom",r,a)],false)]}this._applySearch(t)}},onSaleslocalSearch:function(e){if(e.getParameters().refreshButtonPressed){this.onSalesRefresh()}else{var t=[];var a=e.getParameter("query");if(a&&a.length>0){var r=sap.ui.model.FilterOperator.Contains;t=[new sap.ui.model.Filter([new sap.ui.model.Filter("Material",r,a)],false)]}this._applySalesSearch(t)}},_applySalesSearch:function(e){var t=this.getView().byId("tab");t.getBinding("items").filter(e,"Application")},_applySearch:function(e){var t=this.getView().byId("mattab");t.getBinding("items").filter(e,"Application")},onRefresh:function(){var e=this.getView().byId("mattab");e.getBinding("items").refresh()},onSalesRefresh:function(){var e=this.getView().byId("tab");e.getBinding("items").refresh()},onClear:function(){var e=this.getView().byId("matbtnId");var t=e.getAllFilterItems(true);e.determineControlByFilterItem(t[0]).setValue("");e.determineControlByFilterItem(t[1]).setValue("")},onSalesFilterClear:function(){var e=this.getView().byId("btnId");var t=e.getAllFilterItems(true);e.determineControlByFilterItem(t[0]).setValue("")},onUpdateFinished:function(e){var t,a=e.getSource(),r=e.getParameter("total");if(r&&a.getBinding("items").isLengthFinal()){t=this.getResourceBundle().getText("worklistTableTitleCount",[r])}else{t=this.getResourceBundle().getText("worklistTableTitle")}this.getView().getModel("worklistView").setProperty("/worklistTableTitle",t);this.getView().getModel("worklistView").setProperty("/bomMaterialTableCount",[r])},onLiveChange:function(e){var t=e.getSource().getValue();this.getView().byId("matidPlant").setValue(t.toUpperCase())},matonGo:function(){i.open();var e=this;sap.m.MessageBox.show(" Do you want to proceed?.",{icon:sap.m.MessageBox.Icon.INFORMATION,title:"Search BOM",actions:["OK","Cancel"],onClose:function(t){if(t==="OK"){e.onBOMSearch()}if(t==="Cancel"){i.close()}},initialFocus:"OK"})},onBOMSearch:function(){var e=this.getView().byId("matmultiInput").getValue();var t=this.getView().byId("matidPlant").getValue().toString();if(e.length===0||t.length===0){sap.m.MessageBox.warning("Please enter all mandatory fields.");i.close()}else{this.connectServer()}},connectServer:function(){var e=new sap.ui.model.json.JSONModel;this.getView().setModel(e,"BRF");var t=0,a=[],r=false,s,l,n=[],u=true,d=0,c=[],f=[],m=[],p=[],g=[],h=0;var M=[this.getView().byId("matmultiInput").getValue()];var S=this.getView().byId("matidPlant").getValue().toString();var w=this.getView().getModel("modelA");var O=this.getView().getModel();$.sap.brk=O;var v=this;var P=function(O,F,y){for(var I=0;I<F.length;I++){f.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.EQ,F[I]),new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,S)],and:true}))}m.push(new sap.ui.model.Filter({filters:f,and:false}));for(I=0;I<y.length;I++){g.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Product",sap.ui.model.FilterOperator.EQ,y[I]),new sap.ui.model.Filter("ValuationArea",sap.ui.model.FilterOperator.EQ,S)],and:true}))}p.push(new sap.ui.model.Filter({filters:g,and:false}));var V=function(e){return new Promise(function(t,a){if(F.length===0){t("")}else{O.read(e,{filters:m,urlParameters:{$select:"BillOfMaterialComponent,IsAssembly,Material,BillOfMaterialItemNumber,ComponentDescription,BillOfMaterialItemQuantity",$orderby:"BillOfMaterialItemNumber"},async:false,success:function(e){if(e.results.length===0){i.close();v.getView().byId("matmultiInput").setValue("");v.getView().byId("matidPlant").setValue("");v.getView().byId("matidSC").setValue("");v.getView().byId("matidBOM").setValue("");v.getView().byId("matidPSC").setValue("");v.getView().byId("matidDiff").setValue("");sap.m.MessageToast.show("No Records Found");return}t(e)},error:function(e){a(e)}})}})},C=function(e){return new Promise(function(t,a){if(F.length===0){t("")}else{O.read(e,{filters:m,urlParameters:{$select:"BillOfMaterialVariantUsage,Material"},async:false,success:function(e){t(e)},error:function(e){a(e)}})}})},B=function(e){return new Promise(function(t,a){w.read(e,{filters:p,urlParameters:{$select:"StandardPrice,Product,ValuationArea,PriceUnitQty"},async:false,success:function(e){t(e)},error:function(e){a(e)}})})};Promise.all([V("/MaterialBOMItem"),C("/MaterialBOM"),B("/A_ProductValuation")]).then(function(S){if(S[0]===""&&S[1]===""){for(I=0;I<S[2].results.length;I++){a.push(S[2].results[I])}for(I=0;I<n.length;I++){for(var w=0;w<a.length;w++){if(n[I].bom===a[w].Product){n[I].stc=a[w].StandardPrice;n[I].psc=parseFloat(a[w].StandardPrice/a[w].PriceUnitQty).toFixed(3);n[I].tsc=parseFloat(n[I].qty*(a[w].StandardPrice/a[w].PriceUnitQty)).toFixed(3)}}}var O=0;for(w=0;w<n.length;w++){if(n[w].lvl===1){O=O+parseFloat(n[w].tsc)}}var F=O-$.sap.spc;var y=JSON.parse(JSON.stringify(n));y[0].msp=o.format($.sap.spc);for(I=0;I<y.length;I++){y[I].stc=o.format(y[I].stc);y[I].psc=o.format(y[I].psc);y[I].tsc=o.format(y[I].tsc);y[I].qty=o.format(y[I].qty)}var V=new sap.ui.model.json.JSONModel;V.setSizeLimit(y.length);V.setData(y);v.getView().setModel(V,"OPM");i.close();e=new sap.ui.model.json.JSONModel;e.setSizeLimit(n.length);e.setData(n);v.getView().byId("matidBOM").setValue($.sap.usg);v.getView().byId("matidSC").setValue($.sap.spc);v.getView().byId("matidPSC").setValue($.sap.psc);v.getView().byId("matidDiff").setValue(parseFloat(F).toFixed(3));v.getView().setModel(e,"BRF")}else{h+=1;for(var C=0;C<S[0].results.length;C++){for(var B=0;B<S[1].results.length;B++){if(S[0].results[C].Material===S[1].results[B].Material){d+=1;c.push({mat:S[0].results[C].Material,itm:S[0].results[C].BillOfMaterialItemNumber,bom:S[0].results[C].BillOfMaterialComponent,asm:S[0].results[C].IsAssembly,des:S[0].results[C].ComponentDescription,qty:S[0].results[C].BillOfMaterialItemQuantity,usg:S[1].results[B].BillOfMaterialVariantUsage,stc:"",psc:"",tsc:"",msp:"",lvl:h,idx:d})}}}for(I=0;I<S[2].results.length;I++){a.push(S[2].results[I])}if(u){$.sap.usg=S[1].results[0].BillOfMaterialVariantUsage;$.sap.spc=S[2].results[0].StandardPrice;$.sap.psc=parseFloat(S[2].results[0].StandardPrice/S[2].results[0].PriceUnitQty).toFixed(3);for(var b=0;b<M.length;b++){for(var T=0;T<c.length;T++){if(M[b]===c[T].mat){n.push(c[T])}}}}if(r){for(var x=0;x<n.length;x++){for(var N=0;N<c.length;N++){if(n[x].asm.length>0){if(n[x].bom===c[N].mat){t+=1;n.splice(x+t,0,c[N])}}}t=0}}c=[];u=false;r=true;s=[];l=[];for(var A=0;A<S[0].results.length;A++){if(S[0].results[A].IsAssembly.length>0){s.push(S[0].results[A].BillOfMaterialComponent)}l.push(S[0].results[A].BillOfMaterialComponent)}f=[];m=[];g=[];p=[];P($.sap.brk,s,l)}}).catch(function(e){i.close();var t=JSON.parse(e.responseText);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){return}}})})};P($.sap.brk,M,M)},onGoSales:function(){i.open();var e=this;sap.m.MessageBox.show(" Do you want to proceed?.",{icon:sap.m.MessageBox.Icon.INFORMATION,title:"Search BOM",actions:["OK","Cancel"],onClose:function(t){if(t==="OK"){e.onSalesBOMSearch()}if(t==="Cancel"){i.close()}},initialFocus:"OK"})},onSalesBOMSearch:function(){var e=this.getView().byId("salesInput").getValue();if(e.length===0){sap.m.MessageBox.warning("Please enter all mandatory fields.");i.close()}else{this.onSalesSearch()}},onSalesSearch:function(){var e=this.getView().byId("salesInput").getValue(),t=new sap.ui.model.json.JSONModel,a=this.getView().getModel("modelB"),r=this.getView().getModel("modelA"),s=this;this.getView().setModel(t,"SAM");a.read("/A_SalesOrderItem",{urlParameters:{$select:"SalesOrder,SalesOrderItem,Material,RequestedQuantity,SalesOrderItemText,SalesOrderItemCategory,ProductionPlant",$filter:"(SalesOrder eq '"+e+"')",$orderby:"SalesOrderItem"},async:false,success:function(e){if(e.results.length===0){i.close();s.getView().byId("salesInput").setValue("");sap.m.MessageToast.show("No Records Found");return}var a=[];for(var l=0;l<e.results.length;l++){a.push({SalesOrder:e.results[l].SalesOrder,SalesOrderItem:e.results[l].SalesOrderItem,Material:e.results[l].Material,RequestedQuantity:e.results[l].RequestedQuantity,SalesOrderItemText:e.results[l].SalesOrderItemText,SalesOrderItemCategory:e.results[l].SalesOrderItemCategory,ProductionPlant:e.results[l].ProductionPlant,StandardCost:"",CalculatedStdCost:""})}var o=[];var n=[];var u=[];var d=[];var c=[];var f=e.results[0].ProductionPlant;$.sap.gplant=f;for(var m=0;m<e.results.length;m++){u[m]=e.results[m].Material}for(var p=0;p<u.length;p++){d.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.EQ,u[p]),new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,f),new sap.ui.model.Filter("BillOfMaterialVariantUsage",sap.ui.model.FilterOperator.EQ,"1")],and:true}));o.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Product",sap.ui.model.FilterOperator.EQ,u[p]),new sap.ui.model.Filter("ValuationArea",sap.ui.model.FilterOperator.EQ,f)],and:true}))}n.push(new sap.ui.model.Filter({filters:o,and:false}));c.push(new sap.ui.model.Filter({filters:d,and:false}));var g=s.getView().getModel();var h=function(e,t,a){return new Promise(function(s,l){g.read(e,{filters:c,urlParameters:{$select:"Material,BillOfMaterialVariantUsage,BillOfMaterial"},async:false,success:function(e){var i=[],o=[];$.sap.gmaterial=e.results;for(p=0;p<e.results.length;p++){i.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.EQ,e.results[p].Material),new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,f)],and:true}))}o.push(new sap.ui.model.Filter({filters:i,and:false}));g.read(t,{filters:o,urlParameters:{$select:"BillOfMaterialComponent,IsAssembly,Material,BillOfMaterialItemNumber",$orderby:"BillOfMaterialItemNumber"},async:false,success:function(t){var i=[];for(var o=0;o<t.results.length;o++){i.push({Material:t.results[o].Material,BillOfMaterialComponent:t.results[o].BillOfMaterialComponent,StandardPrice:""})}var n=[],u=[];for(p=0;p<t.results.length;p++){n.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Product",sap.ui.model.FilterOperator.EQ,t.results[p].BillOfMaterialComponent),new sap.ui.model.Filter("ValuationArea",sap.ui.model.FilterOperator.EQ,f)],and:true}))}u.push(new sap.ui.model.Filter({filters:n,and:false}));r.read(a,{filters:u,urlParameters:{$select:"StandardPrice,Product"},async:false,success:function(t){for(p=0;p<i.length;p++){for(var a=0;a<t.results.length;a++){if(i[p].BillOfMaterialComponent===t.results[a].Product){i[p].StandardPrice=t.results[a].StandardPrice}}}var r=0,l=[];for(p=0;p<e.results.length;p++){for(a=0;a<i.length;a++){if(e.results[p].Material===i[a].Material){r=r+parseFloat(i[a].StandardPrice)}}l.push({Material:e.results[p].Material,CalculatedSPwQ:r});r=0}s(l)},error:function(e){l(e)}})},error:function(e){l(e)}})},error:function(e){l(e)}})})};var M=function(e){return new Promise(function(t,a){r.read(e,{filters:n,urlParameters:{$select:"StandardPrice,Product,ValuationArea,PriceUnitQty"},async:false,success:function(e){t(e)},error:function(e){a(e)}})})};Promise.all([h("/MaterialBOM","/MaterialBOMItem","/A_ProductValuation"),M("/A_ProductValuation")]).then(function(e){for(p=0;p<a.length;p++){for(var r=0;r<e[1].results.length;r++){if(a[p].Material===e[1].results[r].Product){a[p].StandardCost=e[1].results[r].StandardPrice;a[p].CalculatedStdCost=parseFloat(e[1].results[r].StandardPrice*a[p].RequestedQuantity).toFixed(3);r=e[1].results.length-1}}}for(p=0;p<a.length;p++){for(r=0;r<e[0].length;r++){if(a[p].Material===e[0][r].Material){a[p].CalculatedStdCost=parseFloat(e[0][r].CalculatedSPwQ*a[p].RequestedQuantity).toFixed(3)}}}for(var l=0;l<a.length;l++){if(a[l].SalesOrderItemCategory==="TAP"||a[l].SalesOrderItemCategory==="CBTP"){a[l].StandardCost="";a[l].CalculatedStdCost=""}if(parseFloat(a[l].StandardCost)===0||parseFloat(a[l].CalculatedStdCost)===0){a[l].StandardCost="";a[l].CalculatedStdCost=""}}t=new sap.ui.model.json.JSONModel;t.setSizeLimit(a.length);t.setData(a);$.sap.sviewdata=JSON.parse(JSON.stringify(a));i.close();s.getView().setModel(t,"SAM")}).catch(function(e){i.close();var t=JSON.parse(e.responseText);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){return}}})})},error:function(e){i.close();var t=JSON.parse(e.responseText);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){return}}})}})},onSalesexcel:function(){var e=new sap.ui.model.json.JSONModel;this.getView().setModel(e,"XLSX");var t=0,a=[],r=false,s,l,n=[],u=true,d=0,c=[],f=[],m=[],p=[],g=[],h=0;var M=[];for(var S=0;S<$.sap.gmaterial.length;S++){M[S]=$.sap.gmaterial[S].Material}var w=$.sap.gplant;var O=this.getView().getModel("modelA");var v=this.getView().getModel();$.sap.brk=v;var P=this;var F=function(v,y,I){for(S=0;S<y.length;S++){f.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.EQ,y[S]),new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,w)],and:true}))}m.push(new sap.ui.model.Filter({filters:f,and:false}));for(S=0;S<I.length;S++){g.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Product",sap.ui.model.FilterOperator.EQ,I[S]),new sap.ui.model.Filter("ValuationArea",sap.ui.model.FilterOperator.EQ,w)],and:true}))}p.push(new sap.ui.model.Filter({filters:g,and:false}));var V=function(e){return new Promise(function(t,a){if(y.length===0){t("")}else{v.read(e,{filters:m,urlParameters:{$select:"BillOfMaterialComponent,IsAssembly,Material,BillOfMaterialItemNumber,ComponentDescription,BillOfMaterialItemQuantity",$orderby:"BillOfMaterialItemNumber"},async:false,success:function(e){if(e.results.length===0){i.close();sap.m.MessageToast.show("No Records Found");return}t(e)},error:function(e){a(e)}})}})},C=function(e){return new Promise(function(t,a){O.read(e,{filters:p,urlParameters:{$select:"StandardPrice,Product,ValuationArea,PriceUnitQty"},async:false,success:function(e){t(e)},error:function(e){a(e)}})})};Promise.all([V("/MaterialBOMItem"),C("/A_ProductValuation")]).then(function(w){if(w[0]===""){for(S=0;S<w[1].results.length;S++){a.push(w[1].results[S])}for(S=0;S<n.length;S++){for(var O=0;O<a.length;O++){if(n[S].Material===a[O].Product){n[S].StandardCost=a[O].StandardPrice;n[S].CalculatedStdCost=parseFloat(n[S].RequestedQuantity*(a[O].StandardPrice/a[O].PriceUnitQty)).toFixed(3)}}}var v=JSON.parse(JSON.stringify($.sap.sviewdata));for(var y=0;y<v.length;y++){for(var I=0;I<n.length;I++){if(v[y].Material===n[I].mat){t+=1;v.splice(y+t,0,n[I])}}t=0}e=new sap.ui.model.json.JSONModel;for(y=0;y<v.length;y++){if(v[y].StandardCost===""&&v[y].CalculatedStdCost===""){v[y].RequestedQuantity=o.format(v[y].RequestedQuantity)}else{v[y].RequestedQuantity=o.format(v[y].RequestedQuantity);v[y].StandardCost=o.format(v[y].StandardCost);v[y].CalculatedStdCost=o.format(v[y].CalculatedStdCost)}}e.setSizeLimit(v.length);e.setData(v);P.getView().setModel(e,"XLSX");i.close();P.onSalesExcelDownload(P)}else{h+=1;for(var V=0;V<w[0].results.length;V++){d+=1;c.push({mat:w[0].results[V].Material,itm:w[0].results[V].BillOfMaterialItemNumber,Material:w[0].results[V].BillOfMaterialComponent,asm:w[0].results[V].IsAssembly,SalesOrderItemText:w[0].results[V].ComponentDescription,RequestedQuantity:w[0].results[V].BillOfMaterialItemQuantity,StandardCost:"",CalculatedStdCost:"",lvl:h,idx:d})}for(S=0;S<w[1].results.length;S++){a.push(w[1].results[S])}if(u){for(var C=0;C<M.length;C++){for(var B=0;B<c.length;B++){if(M[C]===c[B].mat){n.push(c[B])}}}}if(r){for(y=0;y<n.length;y++){for(I=0;I<c.length;I++){if(n[y].asm.length>0){if(n[y].Material===c[I].mat){t+=1;n.splice(y+t,0,c[I])}}}t=0}}c=[];u=false;r=true;s=[];l=[];for(var b=0;b<w[0].results.length;b++){l.push(w[0].results[b].BillOfMaterialComponent)}f=[];m=[];g=[];p=[];F($.sap.brk,s,l)}}).catch(function(e){i.close();var t=JSON.parse(e.responseText);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){return}}})})};F($.sap.brk,M,M)},salesonDataExport:function(){i.open();this.onSalesexcel()}})});