sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/IconPool"],function(e,t,a,r,s,l){"use strict";var i=new sap.m.BusyDialog;var o=sap.ui.core.format.NumberFormat.getFloatInstance({maxFractionDigits:3,decimalSeparator:"."});return e.extend("com.salesbom.culligan.salesbomdisplay.controller.Worklist",{formatter:a,onInit:function(){var e=new t({worklistTableTitle:this.getResourceBundle().getText("worklistTableTitle"),bomMaterialTableCount:""});this.getView().setModel(e,"worklistView");var a=new t({salesTableTitle:this.getResourceBundle().getText("salesTableTitle"),salesOrderTableCount:""});this.getView().setModel(a,"salesView");var r=[];var s={};var i={fontFamily:"SAP-icons-TNT",fontURI:sap.ui.require.toUrl("sap/tnt/themes/base/fonts/")};l.registerFont(i);r.push(l.fontLoaded("SAP-icons-TNT"));s["SAP-icons-TNT"]=i},matonDataExport:function(){this.onExcelDownload(this)},onSalesFinished:function(e){var t,a=e.getSource(),r=e.getParameter("total");if(r&&a.getBinding("items").isLengthFinal()){t=this.getResourceBundle().getText("salesTableTitleCount",[r])}else{t=this.getResourceBundle().getText("salesTableTitle")}this.getView().getModel("salesView").setProperty("/salesTableTitle",t);this.getView().getModel("salesView").setProperty("/salesOrderTableCount",[r])},onSearch:function(e){if(e.getParameters().refreshButtonPressed){this.onRefresh()}else{var t=[];var a=e.getParameter("query");if(a&&a.length>0){var r=sap.ui.model.FilterOperator.Contains;t=[new sap.ui.model.Filter([new sap.ui.model.Filter("bom",r,a)],false)]}this._applySearch(t)}},_applySearch:function(e){var t=this.getView().byId("mattab");t.getBinding("items").filter(e,"Application")},onRefresh:function(){var e=this.getView().byId("mattab");e.getBinding("items").refresh()},onClear:function(){var e=this.getView().byId("matbtnId");var t=e.getAllFilterItems(true);e.determineControlByFilterItem(t[0]).setValue("");e.determineControlByFilterItem(t[1]).setValue("")},onUpdateFinished:function(e){var t,a=e.getSource(),r=e.getParameter("total");if(r&&a.getBinding("items").isLengthFinal()){t=this.getResourceBundle().getText("worklistTableTitleCount",[r])}else{t=this.getResourceBundle().getText("worklistTableTitle")}this.getView().getModel("worklistView").setProperty("/worklistTableTitle",t);this.getView().getModel("worklistView").setProperty("/bomMaterialTableCount",[r])},onLiveChange:function(e){var t=e.getSource().getValue();this.getView().byId("matidPlant").setValue(t.toUpperCase())},matonGo:function(){i.open();var e=this;sap.m.MessageBox.show(" Do you want to proceed?.",{icon:sap.m.MessageBox.Icon.INFORMATION,title:"Search BOM",actions:["OK","Cancel"],onClose:function(t){if(t==="OK"){e.onBOMSearch()}if(t==="Cancel"){i.close()}},initialFocus:"OK"})},onBOMSearch:function(){var e=this.getView().byId("matmultiInput").getValue();var t=this.getView().byId("matidPlant").getValue().toString();if(e.length===0||t.length===0){sap.m.MessageBox.warning("Please enter all mandatory fields.");i.close()}else{this.connectServer()}},connectServer:function(){var e=new sap.ui.model.json.JSONModel;this.getView().setModel(e,"BRF");var t=0,a=[],r=false,s,l,n=[],u=true,d=0,c=[],m=[],f=[],p=[],g=[],h=0;var M=[this.getView().byId("matmultiInput").getValue()];var w=this.getView().byId("matidPlant").getValue().toString();var O=this.getView().getModel("modelA");var S=this.getView().getModel();$.sap.brk=S;var P=this;var F=function(S,v,V){for(var y=0;y<v.length;y++){m.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.EQ,v[y]),new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,w)],and:true}))}f.push(new sap.ui.model.Filter({filters:m,and:false}));for(y=0;y<V.length;y++){g.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Product",sap.ui.model.FilterOperator.EQ,V[y]),new sap.ui.model.Filter("ValuationArea",sap.ui.model.FilterOperator.EQ,w)],and:true}))}p.push(new sap.ui.model.Filter({filters:g,and:false}));var B=function(e){return new Promise(function(t,a){if(v.length===0){t("")}else{S.read(e,{filters:f,urlParameters:{$select:"BillOfMaterialComponent,IsAssembly,Material,BillOfMaterialItemNumber,ComponentDescription,BillOfMaterialItemQuantity",$orderby:"BillOfMaterialItemNumber"},async:false,success:function(e){if(e.results.length===0){i.close();P.getView().byId("matidBOM").setValue("");P.getView().byId("matidSC").setValue("");sap.m.MessageToast.show("No Records Found");return}t(e)},error:function(e){a(e)}})}})},I=function(e){return new Promise(function(t,a){if(v.length===0){t("")}else{S.read(e,{filters:f,urlParameters:{$select:"BillOfMaterialVariantUsage,Material"},async:false,success:function(e){t(e)},error:function(e){a(e)}})}})},b=function(e){return new Promise(function(t,a){O.read(e,{filters:p,urlParameters:{$select:"StandardPrice,Product,ValuationArea,PriceUnitQty"},async:false,success:function(e){t(e)},error:function(e){a(e)}})})};Promise.all([B("/MaterialBOMItem"),I("/MaterialBOM"),b("/A_ProductValuation")]).then(function(w){if(w[0]===""&&w[1]===""){for(y=0;y<w[2].results.length;y++){a.push(w[2].results[y])}for(y=0;y<n.length;y++){for(var O=0;O<a.length;O++){if(n[y].bom===a[O].Product){n[y].stc=a[O].StandardPrice;n[y].psc=parseFloat(a[O].StandardPrice/a[O].PriceUnitQty).toFixed(3);n[y].tsc=parseFloat(n[y].qty*(a[O].StandardPrice/a[O].PriceUnitQty)).toFixed(3)}}}var S=JSON.parse(JSON.stringify(n));S[0].msp=o.format($.sap.spc);for(y=0;y<S.length;y++){S[y].stc=o.format(S[y].stc);S[y].psc=o.format(S[y].psc);S[y].tsc=o.format(S[y].tsc)}var v=new sap.ui.model.json.JSONModel;v.setSizeLimit(S.length);v.setData(S);P.getView().setModel(v,"OPM");i.close();e=new sap.ui.model.json.JSONModel;e.setSizeLimit(n.length);e.setData(n);P.getView().byId("matidBOM").setValue($.sap.usg);P.getView().byId("matidSC").setValue($.sap.spc);P.getView().byId("matidPSC").setValue($.sap.psc);P.getView().setModel(e,"BRF")}else{h+=1;for(var V=0;V<w[0].results.length;V++){for(var B=0;B<w[1].results.length;B++){if(w[0].results[V].Material===w[1].results[B].Material){d+=1;c.push({mat:w[0].results[V].Material,itm:w[0].results[V].BillOfMaterialItemNumber,bom:w[0].results[V].BillOfMaterialComponent,asm:w[0].results[V].IsAssembly,des:w[0].results[V].ComponentDescription,qty:w[0].results[V].BillOfMaterialItemQuantity,usg:w[1].results[B].BillOfMaterialVariantUsage,stc:"",psc:"",tsc:"",msp:"",lvl:h,idx:d})}}}for(y=0;y<w[2].results.length;y++){a.push(w[2].results[y])}if(u){$.sap.usg=w[1].results[0].BillOfMaterialVariantUsage;$.sap.spc=w[2].results[0].StandardPrice;$.sap.psc=parseFloat(w[2].results[0].StandardPrice/w[2].results[0].PriceUnitQty).toFixed(3);for(var I=0;I<M.length;I++){for(var b=0;b<c.length;b++){if(M[I]===c[b].mat){n.push(c[b])}}}}if(r){for(var C=0;C<n.length;C++){for(var T=0;T<c.length;T++){if(n[C].asm.length>0){if(n[C].bom===c[T].mat){t+=1;n.splice(C+t,0,c[T])}}}t=0}}c=[];u=false;r=true;s=[];l=[];for(var x=0;x<w[0].results.length;x++){if(w[0].results[x].IsAssembly.length>0){s.push(w[0].results[x].BillOfMaterialComponent)}l.push(w[0].results[x].BillOfMaterialComponent)}m=[];f=[];g=[];p=[];F($.sap.brk,s,l)}}).catch(function(e){i.close();var t=JSON.parse(e.responseText);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){return}}})})};F($.sap.brk,M,M)},onGoSales:function(){i.open();var e=this;sap.m.MessageBox.show(" Do you want to proceed?.",{icon:sap.m.MessageBox.Icon.INFORMATION,title:"Search BOM",actions:["OK","Cancel"],onClose:function(t){if(t==="OK"){e.onSalesBOMSearch()}if(t==="Cancel"){i.close()}},initialFocus:"OK"})},onSalesBOMSearch:function(){var e=this.getView().byId("salesInput").getValue();if(e.length===0){sap.m.MessageBox.warning("Please enter all mandatory fields.");i.close()}else{this.onSalesSearch()}},onSalesSearch:function(){var e=this.getView().byId("salesInput").getValue(),t=new sap.ui.model.json.JSONModel,a=this.getView().getModel("modelB"),r=this.getView().getModel("modelA"),s=this;this.getView().setModel(t,"SAM");a.read("/A_SalesOrderItem",{urlParameters:{$select:"SalesOrder,SalesOrderItem,Material,RequestedQuantity,SalesOrderItemText,SalesOrderItemCategory,ProductionPlant",$filter:"(SalesOrder eq '"+e+"')",$orderby:"SalesOrderItem"},async:false,success:function(e){var a=[];for(var l=0;l<e.results.length;l++){a.push({SalesOrder:e.results[l].SalesOrder,SalesOrderItem:e.results[l].SalesOrderItem,Material:e.results[l].Material,RequestedQuantity:e.results[l].RequestedQuantity,SalesOrderItemText:e.results[l].SalesOrderItemText,SalesOrderItemCategory:e.results[l].SalesOrderItemCategory,ProductionPlant:e.results[l].ProductionPlant,StandardCost:"",CalculatedStdCost:""})}var o=[];var n=[];var u=[];var d=[];var c=[];var m=e.results[0].ProductionPlant;for(var f=0;f<e.results.length;f++){u[f]=e.results[f].Material}for(var p=0;p<u.length;p++){d.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.EQ,u[p]),new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,m),new sap.ui.model.Filter("BillOfMaterialVariantUsage",sap.ui.model.FilterOperator.EQ,"1")],and:true}));o.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Product",sap.ui.model.FilterOperator.EQ,u[p]),new sap.ui.model.Filter("ValuationArea",sap.ui.model.FilterOperator.EQ,m)],and:true}))}n.push(new sap.ui.model.Filter({filters:o,and:false}));c.push(new sap.ui.model.Filter({filters:d,and:false}));var g=s.getView().getModel();var h=function(e,t,a){return new Promise(function(s,l){g.read(e,{filters:c,urlParameters:{$select:"Material,BillOfMaterialVariantUsage,BillOfMaterial"},async:false,success:function(e){var i=[],o=[];for(p=0;p<e.results.length;p++){i.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.EQ,e.results[p].Material),new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,m)],and:true}))}o.push(new sap.ui.model.Filter({filters:i,and:false}));g.read(t,{filters:o,urlParameters:{$select:"BillOfMaterialComponent,IsAssembly,Material,BillOfMaterialItemNumber",$orderby:"BillOfMaterialItemNumber"},async:false,success:function(t){var i=[];for(var o=0;o<t.results.length;o++){i.push({Material:t.results[o].Material,BillOfMaterialComponent:t.results[o].BillOfMaterialComponent,StandardPrice:""})}var n=[],u=[];for(p=0;p<t.results.length;p++){n.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Product",sap.ui.model.FilterOperator.EQ,t.results[p].BillOfMaterialComponent),new sap.ui.model.Filter("ValuationArea",sap.ui.model.FilterOperator.EQ,m)],and:true}))}u.push(new sap.ui.model.Filter({filters:n,and:false}));r.read(a,{filters:u,urlParameters:{$select:"StandardPrice,Product"},async:false,success:function(t){for(p=0;p<i.length;p++){for(var a=0;a<t.results.length;a++){if(i[p].BillOfMaterialComponent===t.results[a].Product){i[p].StandardPrice=t.results[a].StandardPrice}}}var r=0,l=[];for(p=0;p<e.results.length;p++){for(a=0;a<i.length;a++){if(e.results[p].Material===i[a].Material){r=r+parseFloat(i[a].StandardPrice)}}l.push({Material:e.results[p].Material,CalculatedSPwQ:r});r=0}s(l)},error:function(e){l(e)}})},error:function(e){l(e)}})},error:function(e){l(e)}})})};var M=function(e){return new Promise(function(t,a){r.read(e,{filters:n,urlParameters:{$select:"StandardPrice,Product,ValuationArea,PriceUnitQty"},async:false,success:function(e){t(e)},error:function(e){a(e)}})})};Promise.all([h("/MaterialBOM","/MaterialBOMItem","/A_ProductValuation"),M("/A_ProductValuation")]).then(function(e){for(p=0;p<a.length;p++){for(var r=0;r<e[1].results.length;r++){if(a[p].Material===e[1].results[r].Product){a[p].StandardCost=e[1].results[r].StandardPrice;a[p].CalculatedStdCost=parseFloat(e[1].results[r].StandardPrice*a[p].RequestedQuantity).toFixed(3);r=e[1].results.length-1}}}for(p=0;p<a.length;p++){for(r=0;r<e[0].length;r++){if(a[p].Material===e[0][r].Material){a[p].CalculatedStdCost=parseFloat(e[0][r].CalculatedSPwQ*a[p].RequestedQuantity).toFixed(3)}}}t=new sap.ui.model.json.JSONModel;t.setSizeLimit(a.length);t.setData(a);i.close();s.getView().setModel(t,"SAM")}).catch(function(e){})},error:function(e){}})}})});